{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Index</title>
    <link rel="stylesheet" type="text/css" href="{% static 'personalfinance/styles.css' %}">
</head>
<body>
    <a href="{% url 'login' %}">Login</a>
    <a href="{% url 'register' %}">Signup</a>

    <form id="logout-form" action="{% url 'logout' %}" method="post" style="display: inline;">
        {% csrf_token %}
        <button type="submit">Logout</button>
    </form>

    <h2>Welcome {{ user.username }} Your Personal Finance Dashboard</h2>
    <p>You have {{ fmodel_count }} financial models.</p>

    <h2>Your Financial Models:</h2>
    <ul>
        {% for fmodel_with_income in fmodels_with_income %}
            <li>
                {{ fmodel_with_income.fmodel.id }}: {{ fmodel_with_income.fmodel.fmodel_name }}
                <ul>
                    {% for income in fmodel_with_income.incomes %}
                        <li>{{ income.income_name }}: {{ income.value }}</li>
                    {% endfor %}
                </ul>
            </li>
        {% endfor %}
    </ul>
    

<body>

    <!-- The Modal for FModel -->
    <div id="fmodelModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('fmodelModal')">&times;</span>
            <h2>Create a New Financial Model</h2>
            <form id="createFModelForm">
                <input type="hidden" name="user_id" value="{{ user.id }}">
                <label for="fmodel_name">Name:</label>
                <input type="text" id="fmodel_name" name="fmodel_name" required>
                <button type="button" onclick="submitFModelForm()">Create</button>
            </form>
        </div>
    </div>

    <!-- The Modal for Income -->
    <div id="incomeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('incomeModal')">&times;</span>
            <h2>Add Income</h2>
            <form id="createIncomeForm">
                <input type="hidden" name="user_id" value="{{ user.id }}">
                <label for="fmodel_name">Financial Model Name:</label>
                <input type="text" id="fmodel_name" name="fmodel_name" required>
                <label for="income_name">Income Name:</label>
                <input type="text" id="income_name" name="income_name" required>
                <label for="value">Value:</label>
                <input type="number" step="0.01" id="value" name="value" required>
                <button type="button" onclick="submitIncomeForm()">Add Income</button>
            </form>
        </div>
    </div>

    <!-- Buttons to open the modals 
    <button onclick="openModal('fmodelModal')">Create Financial Model</button>
    <button onclick="openModal('incomeModal')">Add Income</button> -->

    <script>
        // Functions to open and close modals
        function openModal(modalId) {
            document.getElementById(modalId).style.display = "block";
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = "none";
        }

        // Functions to submit forms
        function submitFModelForm() {
            var form = document.getElementById('createFModelForm');
            var formData = new FormData(form);

            fetch("{% url 'create_fmodel' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    closeModal('fmodelModal');
                    location.reload(); // Reload the page to see the new FModel
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function submitIncomeForm() {
            var form = document.getElementById('createIncomeForm');
            var formData = new FormData(form);

            fetch("{% url 'create_income' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    closeModal('incomeModal');
                    location.reload(); // Reload the page to see the new Income
                }
            })
            .catch(error => console.error('Error:', error));
        }
    </script>
</body>

</body>
</html>
