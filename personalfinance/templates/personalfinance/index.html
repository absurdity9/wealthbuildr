{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Index</title>
    <link rel="stylesheet" type="text/css" href="{% static 'personalfinance/styles.css' %}">
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script></head>
<body>
    <a href="{% url 'login' %}">Login</a>
    <a href="{% url 'register' %}">Signup</a>

    <form id="logout-form" action="{% url 'logout' %}" method="post" style="display: inline;">
        {% csrf_token %}
        <button type="submit">Logout</button>
    </form>

    <h2>Welcome {{ user.username }} Your Personal Finance Dashboard</h2>
    <p>You have {{ fmodel_count }} financial models.</p>

    <h2>Your Financial Models:</h2>
    <ul>
        {% for fmodel_with_ie in fmodels_with_income_and_expense %}
            <li>
                FModel ID: {{ fmodel_with_ie.fmodel.id }} </br>
                {{ fmodel_with_ie.fmodel.fmodel_name }}
                <ul>
                    <li><strong>Incomes:</strong>
                        <ul>
                            {% for income in fmodel_with_ie.incomes %}
                                <li>{{ income.income_name }}: {{ income.value }}</li>
                            {% endfor %}
                        </ul>
                    </li>
                    <li><strong>Expenses:</strong>
                        <ul>
                            {% for expense in fmodel_with_ie.expenses %}
                                <li>{{ expense.expense_name }}: {{ expense.value }}</li>
                            {% endfor %}
                        </ul>
                    </li>
                </ul>
            </li>
        {% endfor %}
    </ul>
    
    <div>
        <h2>Create a New Financial Model</h2>
        <form id="createFModelForm">
            <input type="hidden" name="user_id" value="{{ user.id }}">
            <label for="fmodel_name">Name:</label>
            <input type="text" id="fmodel_name" name="fmodel_name" required>
            <button type="button" onclick="submitFModelForm()">Create</button>
        </form>
    </div>

    <div>
    <h2>Add Income</h2>
        <form id="createIncomeForm">
            <input type="hidden" name="user_id" value="{{ user.id }}">
            <label for="fmodel_name">Financial Model Name:</label>
            <input type="text" id="fmodel_name" name="fmodel_name" required>
            <label for="income_name">Income Name:</label>
            <input type="text" id="income_name" name="income_name" required>
            <label for="value">Value:</label>
            <input type="number" step="0.01" id="value" name="value" required>
            <button type="button" onclick="submitIncomeForm()">Add Income</button>
        </form>
    </div>

    <div>
        <h2>Add Expenses</h2>
        <form id="createExpenseForm">
            {% csrf_token %}
            <input type="hidden" name="user_id" value="{{ user.id }}">
            <label for="fmodel_name_expense">Financial Model Name:</label>
            <input type="text" id="fmodel_name_expense" name="fmodel_name" required>
            <label for="expense_name">Expense Name:</label>
            <input type="text" id="expense_name" name="expense_name" required>
            <label for="expense_value">Amount:</label>
            <input type="number" step="0.01" id="expense_value" name="value" required>
            <button type="button" onclick="submitExpenseForm()">Add Expense</button>
        </form>
    </div>

<script>
    function submitFModelForm() {
        var form = document.getElementById('createFModelForm');
        var formData = new FormData(form);

        fetch("{% url 'create_fmodel' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                closeModal('fmodelModal');
                location.reload(); // Reload the page to see the new FModel
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function submitIncomeForm() {
        var form = document.getElementById('createIncomeForm');
        var formData = new FormData(form);

        fetch("{% url 'create_income' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                closeModal('incomeModal');
                location.reload(); // Reload the page to see the new Income
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function submitExpenseForm() {
        const form = document.getElementById('createExpenseForm');
        const user_id = form.user_id.value;
        const fmodel_name = form.fmodel_name.value;
        const expenses = [
            {
                expense_name: form.expense_name.value,
                value: form.value.value
            }
        ];
    
        const data = {
            user_id: user_id,
            fmodel_name: fmodel_name,
            expenses: expenses
        };
    
        fetch('{% url "create_expense" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error adding expense');
            }
            return response.json();
        })
        .then(response => {
            if (response.expenses) {
                alert('Expense added successfully');
            } else {
                alert('An error occurred while adding the expense');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while adding the expense');
        });
    }

</script>

</body>
</html>
