{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Index</title>
    <link rel="stylesheet" type="text/css" href="{% static 'personalfinance/styles.css' %}">
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script></head>
<body>
    <a href="{% url 'login' %}">Login</a>
    <a href="{% url 'register' %}">Signup</a>

    <form id="logout-form" action="{% url 'logout' %}" method="post" style="display: inline;">
        {% csrf_token %}
        <button type="submit">Logout</button>
    </form>

    <h2>Welcome {{ user.username }} Your Personal Finance Dashboard</h2>
    <p>You have {{ fmodel_count }} financial models.</p>

    <h2>Your Financial Models:</h2>
    <ul>
        {% for fmodel_with_ie in fmodels_with_income_and_expense %}
            <li>
                FModel ID: {{ fmodel_with_ie.fmodel.id }} </br>
                {{ fmodel_with_ie.fmodel.fmodel_name }}
                <ul>
                    <li><strong>Incomes:</strong>
                        <ul>
                            {% for income in fmodel_with_ie.incomes %}
                                <li>{{ income.income_name }}: {{ income.value }}</li>
                            {% endfor %}
                        </ul>
                    </li>
                    <li><strong>Expenses:</strong>
                        <ul>
                            {% for expense in fmodel_with_ie.expenses %}
                                <li>{{ expense.expense_name }}: {{ expense.value }}</li>
                            {% endfor %}
                        </ul>
                    </li>
                </ul>
            </li>
        {% endfor %}
    </ul>
    
    <div>
        <h2>Create a New Financial Model</h2>
        <form id="createFModelForm">
            <input type="hidden" name="user_id" value="{{ user.id }}">
            <label for="fmodel_name">Name:</label>
            <input type="text" id="fmodel_name" name="fmodel_name" required>
            <button type="button" onclick="submitFModelForm()">Create</button>
        </form>
    </div>

    <div>
    <h2>Add Income</h2>
        <form id="createIncomeForm">
            <input type="hidden" name="user_id" value="{{ user.id }}">
            <label for="fmodel_name">Financial Model Name:</label>
            <input type="text" id="fmodel_name" name="fmodel_name" required>
            <label for="income_name">Income Name:</label>
            <input type="text" id="income_name" name="income_name" required>
            <label for="value">Value:</label>
            <input type="number" step="0.01" id="value" name="value" required>
            <button type="button" onclick="submitIncomeForm()">Add Income</button>
        </form>
    </div>

    <div>
        <h2>Add Expenses</h2>
        <form id="createExpenseForm">
            {% csrf_token %}
            <input type="hidden" name="user_id" value="{{ user.id }}">
            <label for="fmodel_name_expense">Financial Model Name:</label>
            <input type="text" id="fmodel_name_expense" name="fmodel_name" required>
            
            <div id="expensesContainer">
                <div class="expense-entry">
                    <label for="expense_name_0">Expense Name:</label>
                    <input type="text" id="expense_name_0" name="expense_name" required>
                    <label for="expense_value_0">Amount:</label>
                    <input type="number" step="0.01" id="expense_value_0" name="value" required>
                </div>
            </div>
            
            <button type="button" onclick="addExpenseEntry()">Add Expense</button>
            <button type="button" onclick="submitExpenseForm()">Submit Expenses</button>
        </form>
    </div>

<script>
    function submitFModelForm() {
        var form = document.getElementById('createFModelForm');
        var formData = new FormData(form);

        fetch("{% url 'create_fmodel' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                closeModal('fmodelModal');
                location.reload(); 
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function submitIncomeForm() {
        var form = document.getElementById('createIncomeForm');
        var formData = new FormData(form);

        fetch("{% url 'create_income' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                closeModal('incomeModal');
                location.reload(); 
            }
        })
        .catch(error => console.error('Error:', error));
    }

    let expenseCount = 1;

    function addExpenseEntry() {
        const expensesContainer = document.getElementById('expensesContainer');
        const newEntry = document.createElement('div');
        newEntry.className = 'expense-entry';
        newEntry.innerHTML = `
            <label for="expense_name_${expenseCount}">Expense Name:</label>
            <input type="text" id="expense_name_${expenseCount}" name="expense_name" required>
            <label for="expense_value_${expenseCount}">Amount:</label>
            <input type="number" step="0.01" id="expense_value_${expenseCount}" name="value" required>
        `;
        expensesContainer.appendChild(newEntry);
        expenseCount++;
    }

    function submitExpenseForm() {
        const form = document.getElementById('createExpenseForm');
        const formData = new FormData(form);
        const expensesContainer = document.getElementById('expensesContainer');
        const expenseEntries = expensesContainer.getElementsByClassName('expense-entry');

        const expenses = [];
        for (let i = 0; i < expenseEntries.length; i++) {
            const expenseName = expenseEntries[i].querySelector(`[id^='expense_name_']`).value;
            const expenseValue = expenseEntries[i].querySelector(`[id^='expense_value_']`).value;
            expenses.push({
                expense_name: expenseName,
                value: expenseValue
            });
        }

        const data = {
            user_id: formData.get('user_id'),
            fmodel_name: formData.get('fmodel_name'),
            expenses: expenses
        };

        const csrftoken = formData.get('csrfmiddlewaretoken');

        fetch('{% url "create_expense" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            console.log('Response:', data); // Log the response to the console
            if (data.error) {
                alert(data.error);
            } else {
                alert('Expenses created successfully');
                // Optionally, update the UI with the new expense data
            }
        })
        .catch(error => console.error('Error:', error));
    }

</script>

</body>
</html>
